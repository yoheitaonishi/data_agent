
<div class="flex-1 flex flex-col overflow-hidden">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm flex-shrink-0">
    <div class="flex items-center space-x-4">
        <%= link_to root_path, class: "p-2 rounded-full hover:bg-gray-100 text-gray-500" do %>
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        <% end %>
        <h1 class="text-xl font-bold text-gray-800" id="page-title">
            ジョブ詳細: <%= @agentic_job.id %>
        </h1>
    </div>
  </header>

    <!-- Content Body -->
    <main class="flex-1 overflow-y-auto p-6" id="main-scroll">
        <div class="max-w-full mx-auto space-y-6">

            <!-- Status Card -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 font-medium mb-1">ステータス</p>
                    <div class="flex items-center">
                        <%= status_badge(@agentic_job.status) %>
                        <% if @agentic_job.action_required %>
                            <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i>要対応
                            </span>
                        <% end %>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500 font-medium mb-1">実行日時</p>
                    <p class="text-lg font-mono text-gray-800"><%= @agentic_job.executed_at.strftime('%Y/%m/%d %H:%M:%S') %></p>
                </div>
            </div>

            <!-- Contract Entries -->
            <% if @agentic_job.customers.attached? %>
                <div class="flex justify-end mb-4 space-x-2">
                    <%= link_to rails_blob_path(@agentic_job.customers, disposition: "attachment"), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
                        <i data-lucide="download" class="w-5 h-5 mr-2 text-gray-500"></i>
                        Customers CSV
                    <% end %>

                    <% if @agentic_job.customer_master.attached? %>
                      <%= link_to rails_blob_path(@agentic_job.customer_master, disposition: "attachment"), class: "inline-flex items-center px-4 py-2 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
                          <i data-lucide="download" class="w-5 h-5 mr-2 text-blue-500"></i>
                          Customer Master CSV
                      <% end %>
                    <% end %>

                    <% if @agentic_job.property_master.attached? %>
                      <%= link_to rails_blob_path(@agentic_job.property_master, disposition: "attachment"), class: "inline-flex items-center px-4 py-2 border border-green-300 shadow-sm text-sm font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" do %>
                          <i data-lucide="download" class="w-5 h-5 mr-2 text-green-500"></i>
                          Property Master CSV
                      <% end %>
                    <% end %>
                </div>
            <% end %>

            <% if @contract_entries.any? %>
                <% @contract_entries.each_with_index do |entry, index| %>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                            <h3 class="text-md font-semibold text-gray-800">契約 #<%= index + 1 %>: <%= entry.applicant_name || '名前未設定' %></h3>
                        </div>
                        <div class="p-6">
                            <table class="min-w-full">
                                <tbody class="divide-y divide-gray-100">
                                    <!-- 基本情報 -->
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700 w-1/4">取引先コード</td><td class="py-2 px-4 text-sm text-gray-900">9999999999</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">顧客正式名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">顧客敬称コード</td><td class="py-2 px-4 text-sm text-gray-900">1</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">顧客カナ名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_name_kana || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">顧客略名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">生年月日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_birth_date ? entry.applicant_birth_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">性別</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_gender == 1 ? '男性' : entry.applicant_gender == 2 ? '女性' : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">法人区分</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_is_corporate ? '法人' : '個人' %></td></tr>

                                    <!-- 連絡先1 -->
                                    <tr><td colspan="2" class="py-3 px-4 bg-blue-50 font-semibold text-sm text-blue-900">連絡先1</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">物件名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.property_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">郵便番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact1_postal_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所1</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact1_address1 || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所2</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact1_address2 || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">電話番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact1_phone1 || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">メールアドレス</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact1_email || '-' %></td></tr>

                                    <!-- 連絡先2 -->
                                    <tr><td colspan="2" class="py-3 px-4 bg-blue-50 font-semibold text-sm text-blue-900">連絡先2</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">名前</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact2_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">郵便番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact2_postal_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所1</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact2_address1 || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所2</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact2_address2 || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">電話番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact2_phone1 || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">メールアドレス</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contact2_email || '-' %></td></tr>

                                    <!-- 勤務先 -->
                                    <tr><td colspan="2" class="py-3 px-4 bg-blue-50 font-semibold text-sm text-blue-900">勤務先</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">勤務先名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.workplace_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">部署</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.workplace_department || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">役職</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.workplace_position || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">郵便番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.workplace_postal_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.workplace_address || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">電話番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.workplace_phone || '-' %></td></tr>

                                    <!-- 緊急連絡先 -->
                                    <tr><td colspan="2" class="py-3 px-4 bg-blue-50 font-semibold text-sm text-blue-900">緊急連絡先</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">名前</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.emergency_contact_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">郵便番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.emergency_contact_postal_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.emergency_contact_address || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">電話番号</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.emergency_contact_phone || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">借主との関係</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.emergency_contact_relationship || '-' %></td></tr>

                                    <!-- システム固定値 -->
                                    <tr><td colspan="2" class="py-3 px-4 bg-blue-50 font-semibold text-sm text-blue-900">システム設定値</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">請求書レイアウト区分</td><td class="py-2 px-4 text-sm text-gray-900">0</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">退去精算書レイアウト区分</td><td class="py-2 px-4 text-sm text-gray-900">0</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">督促状レイアウト区分</td><td class="py-2 px-4 text-sm text-gray-900">0</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">書類送付先コード</td><td class="py-2 px-4 text-sm text-gray-900">1</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">DM区分</td><td class="py-2 px-4 text-sm text-gray-900">0</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">請求書発行区分</td><td class="py-2 px-4 text-sm text-gray-900">1</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">入金方法区分</td><td class="py-2 px-4 text-sm text-gray-900">0</td></tr>

                                    <!-- その他のデータベース項目 -->
                                    <tr><td colspan="2" class="py-3 px-4 bg-blue-50 font-semibold text-sm text-blue-900">その他の情報</td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">詳細URL</td><td class="py-2 px-4 text-sm text-gray-900"><% if entry.detail_url %><a href="<%= entry.detail_url %>" target="_blank" class="text-blue-600 hover:underline"><%= entry.detail_url %></a><% else %>-<% end %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">Entry Head ID</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.entry_head_id || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">部屋ID</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.room_id || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">住所（物件）</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.address || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">面積</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.area || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">賃料</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.rent ? "¥#{number_with_delimiter(entry.rent)}" : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">管理費</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.management_fee ? "¥#{number_with_delimiter(entry.management_fee)}" : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">敷金</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.deposit ? "¥#{number_with_delimiter(entry.deposit)}" : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">礼金</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.key_money ? "¥#{number_with_delimiter(entry.key_money)}" : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">保証金</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.guarantee_deposit ? "¥#{number_with_delimiter(entry.guarantee_deposit)}" : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">申込日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.application_date ? entry.application_date.strftime('%Y/%m/%d %H:%M') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">優先度</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.priority || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">エントリーステータス</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.entry_status || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">仲介会社名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.broker_company_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">仲介会社電話</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.broker_phone || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">仲介担当者名</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.broker_staff_name || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">仲介担当者電話</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.broker_staff_phone || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">仲介担当者メール</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.broker_staff_email || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">保証会社</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.guarantee_company || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">保証審査結果</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.guarantee_result || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">契約方法</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contract_method || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">申込方法</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.application_method || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">申込者タイプ</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.applicant_type || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">物件コード</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.property_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">契約コード</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contract_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">顧客コード</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.customer_code || '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">入居日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.move_in_date ? entry.move_in_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">契約開始日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contract_start_date ? entry.contract_start_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">契約完了日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contract_complete_date ? entry.contract_complete_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">契約日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contract_date ? entry.contract_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">契約終了日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.contract_end_date ? entry.contract_end_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">初回契約日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.initial_contract_date ? entry.initial_contract_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">売上計上日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.revenue_recording_date ? entry.revenue_recording_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">賃料開始日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.rent_start_date ? entry.rent_start_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">未払計上日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.unpaid_recording_date ? entry.unpaid_recording_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                    <tr><td class="py-2 px-4 bg-gray-50 font-medium text-sm text-gray-700">支払予定日</td><td class="py-2 px-4 text-sm text-gray-900"><%= entry.payment_scheduled_date ? entry.payment_scheduled_date.strftime('%Y/%m/%d') : '-' %></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <% end %>
            <% else %>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <p class="text-center text-gray-500 text-sm">取得されたデータがありません。</p>
                </div>
            <% end %>
        </div>
    </main>
</div>

<!-- Icons -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
